// PD-2583 - test comment
//http://bbqa.starfishsolutions.com/webapps/sfrs-' + starfishPluginHandle + '-bb_bb60/do/starfish/sysSettings
Ext.namespace("SF.mini");

SF.mini.standardFormat = 'Y-m-d H:i';

SF.mini.renderDate = function(date) {
	var dateDisp;
	var today = new Date();
	var tomorrow = new Date();
	tomorrow.setDate(today.getDate() + 1);
	
	if (date) {
		var dayYear = date.getDayOfYear() + date.getYear();

		if (today.getDayOfYear() + today.getYear() == dayYear) {
			dateDisp = 'Today at ';
		} else if (tomorrow.getDayOfYear() + tomorrow.getYear() == dayYear) {
			dateDisp = 'Tomorrow at ';
		} else {
			dateDisp = date.format('m-d-Y: ');
		}
	}
	
	return dateDisp;
};

SF.mini.renderTime = function (date) {
	return date.format('g:i a');
}; 


SF.mini.writeNavLink = function(starfishUrl, starfishPluginHandle, html, redirect, lastLink) {
	var sfMiniDashNavId = 'miniDashNav-' + starfishPluginHandle;
	Ext.DomHelper.append( Ext.get(sfMiniDashNavId),{
		tag: 'a',
		href: starfishUrl + ((redirect && redirect != '') ?'&redirect='+redirect : ''),
		html: html,
		style: 'font-family:tahoma,verdana,sans-serif;font-size:12px;font-weight:bold;color:#ffffff;'
	});
	
	if (!lastLink) {
		Ext.DomHelper.append( Ext.get(sfMiniDashNavId),{
			tag: 'span',
			href: starfishUrl + ((redirect && redirect != '') ?'&redirect='+redirect : ''),
			html: ' | ',
			style: 'font-family:tahoma,verdana,sans-serif;font-size:12px;font-weight:bold;color:#ffffff;'
		});
	}
};

SF.mini.writeSurveyReminders = function(starfishUrl, starfishPluginHandle, userId, surveys) {
	if (!surveys) { return; }
	var miniDashSurveyTableId = 'miniDashSurveyTable-' + starfishPluginHandle;
	var surveyHtml = 
		'<tr> ' +
		'<td valign="top"> ' +
		'<img src="/webapps/sfrs-' + starfishPluginHandle + '-bb_bb60/images/bullet.png" width="12" height="11"/>' +
		'</td>' +
		'<td valign="top" style="font-family:verdana,sans-serif;font-size:12px;">' +
		'<p style="margin-top: -5px;">' +
		'<a href="{surveyLinkTarget}" style="color:#336699;">' +
		'{surveyName}' +
		'</a>' +
		'</p>' +
		'</td>' +
		'</tr>';
		
	var surveyTemplate = new Ext.Template(surveyHtml);
	surveyTemplate.compile();
	
	for(var i=0; i<surveys.length;i++) {
		var survey = surveys[i];
		surveyLinkTarget = starfishUrl + "&redirect=SURVEYS&surveyId="+survey.surveyId;
		surveyTemplate.append( Ext.get(miniDashSurveyTableId),{
			surveyLinkTarget: surveyLinkTarget,
			surveyName: survey.surveyName
		});
	}
};

SF.mini.writeNoAppointments = function(starfishPluginHandle) {
	    var starfishMiniDashApptsTableId = 'miniDashApptsTable' + starfishPluginHandle;
		var appHtml =
		'<tr>' +
		'<td valign="top"><img src="/webapps/sfrs-' + starfishPluginHandle + '-bb_bb60/images/bullet.png" width="12" height="11"/></td>' +
		'<td valign="top" style="font-family:verdana,sans-serif;font-size:12px;color:#333333;">' +
		'<p style="margin-top: -5px;">{message}' +
		'</p>' +
		'</td>' +
		'</tr>';
		var apptTemplate = new Ext.Template(appHtml);
		apptTemplate.compile();
	
		apptTemplate.append( Ext.get(starfishMiniDashApptsTableId),{
			message: "No Appointments"
		});
};


SF.mini.writeUpcomingAppointments = function(starfishUrl, starfishPluginHandle, userId, upcomingAppointments) {
	if (!upcomingAppointments) { return; }
	var starfishMiniDashApptsTableId = 'miniDashApptsTable' + starfishPluginHandle;
	var appHtml = 
		'<tr>' +
		'<td valign="top"><img src="/webapps/sfrs-' + starfishPluginHandle + '-bb_bb60/images/bullet.png" width="12" height="11"/></td>' +
		'<td valign="top" style="font-family:verdana,sans-serif;font-size:12px;color:#333333;">' +
		'<p style="margin-top: -5px;">' +
		'<a href="{personLinkTarget}" style="color:#336699;font-weight:500;">' +
		'{name}</a>: {date}<a href="{apptLinkTarget}">{time}</a> <br/><strong>Reason:</strong> <em>{reason}</em><br/>' +
		'<strong>Location:</strong> {location}' +
		'</p>' +
		'</td>' +
		'</tr>';
		
	var reservedTimeHtml = 
		'<tr>' +
		'<td valign="top"><img src="/webapps/sfrs-' + starfishPluginHandle + '-bb_bb60/images/bullet.png" width="12" height="11"/></td>' +
		'<td valign="top" style="font-family:verdana,sans-serif;font-size:12px;color:#333333;">' +
		'<p style="margin-top: -5px;">' +
		'<a href="{personLinkTarget}" style="color:#336699;font-weight:500;">' +
		'{name}</a>: {date}<a href="{apptLinkTarget}">{time}</a> <br/><strong>Reason:</strong> <em>{reason}</em><br/>' +
		'</p>' +
		'</td>' +
		'</tr>';
		
	var apptTemplate = new Ext.Template(appHtml);
	apptTemplate.compile();
		
	var reservedTimeTemplate = new Ext.Template(reservedTimeHtml);
	reservedTimeTemplate.compile();
		
	
	for(var i=0; i<upcomingAppointments.length;i++) {
		var appointment = upcomingAppointments[i];
		
		var name;
		var apptLinkTarget = "#";
		

        // example links
        // http://stage.starfishsolutions.com:8080/starfish-stage/appointments/appointments.html?subWindow=editAppointment&appId=1078&date=Mon%20Oct%2019%202009%2015%3A00%3A00%20GMT-0400%20(EST)&scheduleBlockId=1077
    	// http://stage.starfishsolutions.com:8080/starfish-stage/instructor/studentProfile.html?studentId=4293
    	// http://stage.starfishsolutions.com:8080/starfish-stage/appointments/appointments.html?subWindow=editGroupSessionParticipants&scheduleBlockId=1074&date=Mon%20Oct%2019%202009%2016%3A00%3A00%20GMT-0400%20(EST)
    	// http://stage.starfishsolutions.com:8080/starfish-stage/appointments/appointments.html?instuid=4260
		
		var personLinkTarget = "#";
		
		var startDate = Date.parseDate(appointment.startDate, SF.mini.standardFormat);
		
		var reason =  appointment.appointmentTypeReason ? appointment.appointmentTypeReason.name : '';
		
				
		if (userId == appointment.takerId) {
			personLinkTarget = starfishUrl + "&redirect=PROFILE&partyId="+appointment.makerId;
		} else {
			personLinkTarget = starfishUrl + "&redirect=INSTRUCTOR_CALENDAR&mode=makeAppointment&instuid="+appointment.takerId;
		}
		
		if (appointment.meetingType == 'Appointment') {
			if (appointment.group) {
				// for group sessions just show the group session name
				reason = appointment.groupName;
				if (userId == appointment.takerId) {
					name = "Group Session";
					
					apptLinkTarget = starfishUrl + "&redirect=MY_CALENDAR&subWindow=editGroupSessionParticipants&appId="+appointment.appId+"&date="+encodeURIComponent(startDate)+"&scheduleBlockId="+appointment.scheduleBlockId;
					personLinkTarget = apptLinkTarget;
				} else {
					name = appointment.takerName;
					apptLinkTarget = starfishUrl + "&redirect=INSTRUCTOR_CALENDAR&mode=makeAppointment&instuid="+appointment.takerId+"&date="+encodeURIComponent(startDate);
				}
			} else {
				if (userId == appointment.takerId) {
					name = appointment.makerName;
					apptLinkTarget = starfishUrl + "&redirect=MY_CALENDAR&subWindow=editAppointment&appId="+appointment.appId+"&date="+encodeURIComponent(startDate)+"&scheduleBlockId="+appointment.scheduleBlockId;
				} else {
					name = appointment.takerName;
					apptLinkTarget = starfishUrl + "&redirect=INSTRUCTOR_CALENDAR&mode=makeAppointment&instuid="+appointment.takerId+"&date="+encodeURIComponent(startDate);
				}
			}
			
					
			apptTemplate.append( Ext.get(starfishMiniDashApptsTableId),{
				name: name,
				apptLinkTarget: apptLinkTarget,
				personLinkTarget: personLinkTarget,
				date: SF.mini.renderDate(startDate),
				time:SF.mini.renderTime(startDate),
				reason: reason,
				location: appointment.where
			});
		} else {
			name = "Reserved Time";
			apptLinkTarget = starfishUrl + "&redirect=MY_CALENDAR&subWindow=editReservedTime&appId="+appointment.appId+"&date="+encodeURIComponent(startDate)+"&scheduleBlockId="+appointment.scheduleBlockId;
			personLinkTarget = apptLinkTarget;
			reason = appointment.description;
			
			reservedTimeTemplate.append( Ext.get(starfishMiniDashApptsTableId),{
				name: name,
				apptLinkTarget: apptLinkTarget,
				personLinkTarget: personLinkTarget,
				date: SF.mini.renderDate(startDate),
				time:SF.mini.renderTime(startDate),
				reason: reason
			});
		}
	}
};
