/* 
*	SmartEvals Block - JSON Module
*	Version 2.20
*	Copyright 2003-2014 Gap Technologies, Inc.
*	https://www.smartevals.com
*/

var smartevals = {};
 
/* 
*	Render Blocks
*/
smartevals.renderHTML = function(JSONData) {
	if (JSONData != null)
	{	
		var elementsce = $j('.block_smartevals_courseevals');
		var elementsdg = $j('.block_smartevals_dropguard');
		var elementsmf = $j('.block_smartevals_myfocus');
		var elementlogo = $j('.block_smartevals_logo');
		var elementlogin = $j('.block_smartevals_loginlink');
		
		var elementblockaccessvideo = $j('.block_smartevals_blockaccessvideo');  //
		
		var elementMessage = $j('.block_smartevals_message');
		var elementsMessageLinks = $j('.block_smartevals_message_evals');
		var hasMessageBox = elementMessage.length > 0;
		var hasMessageBoxLinks = elementsMessageLinks.length > 0;
				
		var hasblockaccessvideo = elementblockaccessvideo.length > 0; //
		
		var hasce = elementsce.length > 0;
		var hasdg = elementsdg.length > 0;
		var hasmf = elementsmf.length > 0;
		var haslogo = elementlogo.length > 0;
		var hasloginlink = elementlogin.length > 0;
		var htmlStr = "";
		var linkValue = "";
		var linkURL = "";
		
		
		if (!hasce && !hasdg && !hasmf && !hasloginlink) return;
		
		// Render Course Evaluations Data
		if (hasce != null) {
			htmlStr = "";
			if ((JSONData.result == 1) || (JSONData.loginlink == 1)) {							
				htmlStr = this.renderItem(JSONData, 1);	
				if (JSONData.count == 0) {	
					htmlStr += "<div class=\"noItems\" style=\" text-align: center \">There are no more evaluations left.</div>"
				}
				
			} else {
				if (JSONData.result == 2) {
					htmlStr += "<div class=\"noItems\" style=\" text-align: center \">There are no more evaluations left.</div>"
				} else {
					htmlStr += "<div class=\"noItems\" style=\" text-align: center \">No information about upcoming course evaluations found.</div>"
				}
			}
					
			for (var i = 0; i < elementsce.length; i++){
				if (i > 2) break; // no more than 3 instances
				var newDiv = document.createElement("div");
				newDiv.innerHTML = htmlStr;
				elementsce[i].innerHTML = "";	
				elementsce[i].appendChild(newDiv);
			}
					
			// Show a Course Restriction Box if there are evaluations to complete			
			if ((JSONData.count > 0)  && (JSONData.blockaccessvideo < 2) && (hasMessageBox) && (hasMessageBoxLinks)) {
				// Copy link over to that box
				var newDiv = document.createElement("div");
				//newDiv.setAttribute("id", "pDiv");
				newDiv.innerHTML = htmlStr;
				elementsMessageLinks[0].innerHTML = "";	
				elementsMessageLinks[0].appendChild(newDiv);				
				elementMessage[0].style.display = "";				
			}
	
		}
		
		// Render DropGuard Data
		if (hasdg != null) {
			htmlStr = "";
			if ((JSONData.warningscount > 0)) {
				htmlStr = this.renderItem(JSONData, 2);		
			} else {
				htmlStr += "<div class=\"noItems\" style=\" text-align: center \">No recent notes found.</div>"
			}
			
			for (var i = 0; i < elementsdg.length; i++){
				if (i > 2) break; // no more than 3 instances
				var newDiv = document.createElement("div");
				newDiv.innerHTML = htmlStr;
				elementsdg[i].innerHTML = "";	
				elementsdg[i].appendChild(newDiv);
			}
		}
		
		// Render MyFocus Data
		if (hasmf != null) {
			htmlStr = "";
			if ((JSONData.focuscount > 0)) {
				htmlStr = this.renderItem(JSONData, 3);		
			} else {
				htmlStr += "<div class=\"noItems\" style=\" text-align: center \">No recent MyFocus data found.</div>"
			}

			for (var i = 0; i < elementsmf.length; i++){
				if (i > 2) break; // no more than 3 instances
				var newDiv = document.createElement("div");
				newDiv.innerHTML = htmlStr;
				elementsmf[i].innerHTML = "";	
				elementsmf[i].appendChild(newDiv);
			}
		}
		
		// Render Logo 
		if (JSONData.logo == 1 && haslogo == true) {
			for (var i = 0; i < elementlogo.length; i++){
				if (i > 2) break; // no more than 3 instances
				var newDiv = document.createElement("div");
				newDiv.innerHTML = "<div style=\" text-align: center \"><img src=\""+JSONData.logourl+"\"/></div>";
				elementlogo[i].innerHTML = "";	
				elementlogo[i].appendChild(newDiv);
			}
		}
		
		
		//----------------
		// Render BlockaAccessVideo
		if (JSONData.blockaccessvideo == 1 && hasblockaccessvideo == true) {
			for (var i = 0; i < elementblockaccessvideo.length; i++){
				if (i > 2) break; // no more than 3 instances
				var newDiv = document.createElement("div");
				newDiv.innerHTML = "<div style=\" text-align: center \"><video width=\"360\" height=\"200\" autoplay loop><source src=\""+JSONData.blockaccessvideourl+"\" type=\"video/mp4\"></video></div>";
				///newDiv.innerHTML = "<div style=\" text-align: center \"><video width=\"360\" height=\"200\" autoplay loop><source src=\"http://localhost:4343/student/moodleVideo.aspx?s="+schooid+"\" type=\"video/mp4\"></video></div>";
				////newDiv.innerHTML = "<div style=\" text-align: center \"><video width=\"360\" height=\"200\" autoplay loop><source src=\"https://files.smartevals.com/7-GapTechnologies/moodleVideo/blockaccess.mp4\" type=\"video/mp4\"></video></div>";
				 
				elementblockaccessvideo[i].innerHTML = "";	
				elementblockaccessvideo[i].appendChild(newDiv);
			} 
		} else if (JSONData.blockaccessvideo == 2) {
		    
		} else {
		
				for (var i = 0; i < elementblockaccessvideo.length; i++){
				if (i > 2) break; // no more than 3 instances
				var newDiv = document.createElement("div");
				
				if (JSONData.blockaccesstext.length > 5){
				
				newDiv.innerHTML = "<div style=\" text-align: center \"><h2>"+JSONData.blockaccesstext+"</h2></div>";
				elementblockaccessvideo[i].innerHTML = "";	
				elementblockaccessvideo[i].appendChild(newDiv);
							
				} else {
				
				newDiv.innerHTML = "<div style=\" text-align: center \"><h2>54321</h2></div>";
				elementblockaccessvideo[i].innerHTML = "";	
				elementblockaccessvideo[i].appendChild(newDiv);
				
				
				}
			} 
		}		
		
		//--------------
		
		// Render Login Links
		if (JSONData.loginlink != null && JSONData.loginlink != 0 && hasloginlink == true) {
			for (var i = 0; i < elementlogin.length; i++){
				if (i > 2) break; // no more than 3 instances
				var loginname = JSONData.logintolabel;
				if (loginname == null) loginname = "Login to SmartEvals";
				var newDiv = document.createElement("div");
				newDiv.innerHTML = "<a href=\"" + JSONData.loginlink + "\">" + loginname + "</a>"; 
				elementlogin[i].innerHTML = "";	
				elementlogin[i].appendChild(newDiv);
			}
		}

	}
}

/*
*	Render Item
*/
smartevals.renderItem = function(JSONData, what) {
	htmlStr = ""
	htmlStr += "<ul class=\"portletList\">";
	
	$cnt = 0;
	$items = null;
	
	if (what == 1) {
		$cnt = JSONData.count;
		$items = JSONData.classes;
	}
	if (what == 2) {
		$cnt = JSONData.warningscount;
		$items = JSONData.warnings;
	}
	if (what == 3) {
		$cnt = JSONData.focuscount;
		$items = JSONData.myfocus;
	}
		
	// Server should not return many rows but just in case we'll limit here
	if ($cnt > 15) $cnt = 15;
	
	for (i=0; i<$cnt; i++)
	{
		htmlStr += "<li>";
			
		// Strip HTML data and render link	   
		linkValue = $items[i].value;
		linkURL = $items[i].url;
			
		if ((linkValue != null) && (linkURL != null)) {
			linkValue = linkValue.replace(/<(?:.|\s)*?>/g, "");
			linkURL = linkURL.replace(/<(?:.|\s)*?>/g, "");
				
			htmlStr += "<a href=\"" + linkURL + "\" >" +linkValue + "</a>"; //  target='_top' 
		}						

		htmlStr += "</li>";
	}
			
	htmlStr+= "</ul>";
	
	return htmlStr;
}

/* 
*	JSON Callback Render HTML
*/
function block_smartevals_getClasses(JSONData) {
	smartevals.renderHTML(JSONData);
}
